name: continuous integration

on:
  workflow_call:
    inputs:
      slack-channel:
        description: slack channel for send message
        required: true
        type: string

    secrets:
      extra-index-url:
        description: pipy extra index url
        required: true

      trusted-host:
        description: pipy trusted host
        required: true

      slack-token:
        description: slack token for send message
        required: true


jobs:
  version-check:
    runs-on: ubuntu-20.04
    name: version check and linter

    steps:
      - name: Checkout the CI-target repository
        uses: actions/checkout@v3

      - name: Checkout the action repository
        uses: actions/checkout@v3
        with:
          repository: teamdable/vv-continuous-integration
          path: action/
      
      - name: Setup Python Environment
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      
      - name: Install packages for report
        run: |
          python -m pip install --upgrade pip
          pip install -r action/requirements.txt --trusted-host ${{ secrets.trusted-host }} --extra-index-url ${{ secrets.extra-index-url }}
      
      - name: Check install files
        id: check-modified-files
        run: ./check-modified-files --base-sha ${{ github.event.pull_request.base.sha }}

      - name: Version 파일이 변경되었는 지 체크
        run: |
          ./action/version-check \
            --token ${{ secrets.slack-token }} \
            --channel ${{ inputs.slack-channel }} \
            --repo-name ${{ github.event.repository.name }} \
            --branch-name ${{ github.event.pull_request.head.ref }} \
            --base-name ${{ github.event.pull_request.base.ref }} \
            --base-sha ${{ github.event.pull_request.base.sha }} \
            --pull-request-number ${{ github.event.number }}
      
      - name: Pylint Test
        if: steps.check-modified-files.any-python-files
        run: |
          ./action/pylint-test \
            --min-score 8.0 \
            --token ${{ secrets.slack-token }} \
            --channel ${{ inputs.slack-channel }} \
            --repo-name ${{ github.event.repository.name }} \
            --branch-name ${{ github.event.pull_request.head.ref }} \
            --base-name ${{ github.event.pull_request.base.ref }} \
            --base-sha ${{ github.event.pull_request.base.sha }} \
            --pull-request-number ${{ github.event.number }}
